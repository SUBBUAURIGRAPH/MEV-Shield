# MEV Shield - Claude AI Assistant Documentation

## Build and Deployment Scripts for HMS (Health Management System)

This document contains the essential scripts for building and deploying the MEV Shield HMS (Health Management System) in the future development cycles.

### Core Deployment Scripts

#### 1. Remote Development Environment Setup (`remote_dev4.sh`)

**Purpose**: Sets up the complete development environment on a remote server (Dev4)

**Usage**: 
```bash
sudo ./remote_dev4.sh
```

**Key Features**:
- System dependencies installation (Docker, Rust, PostgreSQL client, Redis tools)
- Service user creation and directory setup
- Firewall configuration for MEV Shield ports
- Systemd service configuration
- Environment file creation with secure passwords
- Docker and Docker Compose installation

**Ports Configured**:
- 8080: API port
- 9090: Metrics port  
- 3000: Grafana dashboard
- 9091: Prometheus metrics

#### 2. Complete Deployment Script (`deploy_dev4_complete.sh`)

**Purpose**: Handles the complete build and deployment process for Dev4 environment

**Usage**:
```bash
./deploy_dev4_complete.sh
```

**Key Features**:
- Prerequisites checking
- Automatic backup creation before deployment
- Service stopping and cleanup
- Rust application building with tests
- Docker image building (core + dashboards)
- Configuration setup with environment variables
- Health checks and service validation
- Systemd service management

**Deployment Flow**:
1. Check prerequisites (Docker, project directory)
2. Create timestamped backup
3. Stop existing services gracefully
4. Build Rust application with cargo
5. Build Docker images
6. Deploy with Docker Compose
7. Perform health checks
8. Start systemd service
9. Display status and useful commands

#### 3. Docker Compose Configuration (`docker-compose.yml`)

**Purpose**: Orchestrates all MEV Shield services and dependencies

**Services Included**:
- **PostgreSQL Database**: Primary data storage
- **Redis Cache**: High-performance caching layer
- **MEV Shield Core**: Main Rust application
- **Prometheus**: Metrics collection
- **Grafana**: Visualization and monitoring dashboards

**Key Features**:
- Health checks for all services
- Persistent volumes for data
- Environment variable configuration
- Service dependencies and startup order
- Network isolation with custom bridge network

### Usage Instructions

#### Initial Setup (First Time)
```bash
# 1. Run remote environment setup (as root)
sudo ./remote_dev4.sh

# 2. Clone MEV Shield repository to /opt/mev-shield
cd /opt/mev-shield
git clone <repository-url> .

# 3. Switch to service user
sudo su - mevshield

# 4. Run complete deployment
./deploy_dev4_complete.sh
```

#### Regular Deployments
```bash
# For subsequent deployments, just run:
./deploy_dev4_complete.sh
```

#### Service Management
```bash
# Start services
systemctl start mev-shield

# Stop services  
systemctl stop mev-shield

# Check status
systemctl status mev-shield

# View logs
docker-compose logs -f

# Restart specific service
docker-compose restart mevshield
```

### Environment Configuration

The deployment uses environment-specific configuration in `.env.dev4`:

```bash
ENVIRONMENT=dev4
RUST_LOG=info
POSTGRES_PASSWORD=<auto-generated>
GRAFANA_PASSWORD=<auto-generated>
DATABASE_URL=postgresql://mevshield:${POSTGRES_PASSWORD}@postgres:5432/mevshield
REDIS_URL=redis://redis:6379
API_HOST=0.0.0.0
API_PORT=8080
METRICS_PORT=9090
```

### Monitoring and Health Checks

#### Service URLs
- **API Endpoint**: http://localhost:8080
- **Health Check**: http://localhost:8080/health
- **Metrics**: http://localhost:9090
- **Grafana Dashboard**: http://localhost:3000
- **Prometheus**: http://localhost:9091

#### Log Locations
- **Deployment Logs**: `/var/log/mev-shield/deployment.log`
- **Application Logs**: `/opt/mev-shield/logs/`
- **Docker Logs**: `docker-compose logs`

### Backup and Recovery

#### Automatic Backups
- Created before each deployment
- Stored in `/opt/mev-shield-backups/`
- Keeps last 5 backups automatically
- Timestamped format: `mev-shield-backup-YYYYMMDD_HHMMSS.tar.gz`

#### Manual Backup
```bash
cd /opt/mev-shield-backups
tar -czf manual-backup-$(date +%Y%m%d_%H%M%S).tar.gz -C /opt/mev-shield .
```

### Security Considerations

#### Firewall Rules
- SSH access allowed
- MEV Shield ports (8080, 9090, 3000, 9091) allowed
- All other incoming traffic denied
- Outgoing traffic allowed

#### File Permissions
- Service runs as dedicated `mevshield` user
- Environment files have 600 permissions
- Project directory owned by service user
- Log directory properly secured

### Troubleshooting

#### Common Issues
1. **Docker not found**: Run `remote_dev4.sh` first
2. **Permission denied**: Ensure running as `mevshield` user or root
3. **Port conflicts**: Check if ports 8080, 9090, 3000, 9091 are available
4. **Health check failures**: Check Docker container logs

#### Debug Commands
```bash
# Check container status
docker-compose ps

# View specific service logs
docker-compose logs mevshield

# Check system resources
htop

# Test API connectivity
curl http://localhost:8080/health

# Check firewall status
ufw status
```

### Future Enhancements

These scripts provide the foundation for:
- Multi-environment deployments (dev, staging, prod)
- Blue-green deployment strategies
- Automated CI/CD integration
- Kubernetes migration path
- Enhanced monitoring and alerting
- SSL/TLS certificate automation

---

**Note**: Always test deployments in development environment before applying to production. Ensure proper backup procedures are in place and recovery plans are tested.
